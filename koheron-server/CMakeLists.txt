cmake_minimum_required(VERSION 3.2)

project(koheron_server)

# Locate GTest
set(CMAKE_CONFIGURATION_TYPES "Release" CACHE STRING "" FORCE)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
include(FetchContent)
Set(FETCHCONTENT_QUIET FALSE)
FetchContent_Declare(
    yaml-cpp
    GIT_REPOSITORY https://github.com/jbeder/yaml-cpp
    GIT_PROGRESS TRUE
    # Enter the desired git tag below
    GIT_TAG master
)
FetchContent_MakeAvailable(yaml-cpp)

if (tARM)
  message(STATUS "Compiling for ARM")
  set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -march=armv7-a  -mfpu=neon -mfloat-abi=hard ")
elseif (tARM64)
  message(STATUS "Compiling for ARM64")
  set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -march=armv8-a -mcpu=cortex-a53 ")
endif()
set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -flto -Wall  -Wextra -MMD -MP -O3 ")
set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -Wpedantic -Wfloat-equal -Wunused-macros -Wcast-qual -Wuseless-cast -Wno-error=stringop-truncation")
set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -Wlogical-op -Wdouble-promotion -Wformat -Wmissing-include-dirs -Wundef ")
set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -Wcast-align -Wpacked -Wredundant-decls -Wvarargs -Wvector-operation-performance -Wswitch-default ")
set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -Wuninitialized -Wshadow -Wzero-as-null-pointer-constant -Wmissing-declarations -Wno-switch-default ")
 
include_directories(autogenerated)
include_directories(drivers)
include_directories(core)
include_directories(context)

include_directories(./.) # update this line to compile for different device

file(GLOB_RECURSE core ./core/*.cpp)
file(GLOB_RECURSE context ./context/*.cpp)
file(GLOB_RECURSE auto ./autogenerated/*.cpp)
option(YAML_BUILD_SHARED_LIBS "Build yaml-cpp shared library" OFF)

# Link runTests with what we want to test and the GTest and pthread library

#create test program
add_executable (serverd ${core} ${context} ${auto})
target_link_libraries (serverd pthread explain yaml-cpp)
install(TARGETS serverd RUNTIME DESTINATION bin )
install(FILES koheron-server.service DESTINATION /etc/systemd/system/.)
install(FILES koheron-startracker.yaml DESTINATION /usr/share/.)
install(FILES koheron-startracker.json DESTINATION /usr/share/.)
